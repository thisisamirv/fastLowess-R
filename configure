#!/bin/sh

# Detect OS
# This script configures the package for cross-platform builds
UNAME=$(uname)

# Default target directory
TARGET_DIR="../target"

# Robust WASM detection
IS_WASM=0

# 1. Check for CARGO_BUILD_TARGET or HOST variables
if [ "$CARGO_BUILD_TARGET" = "wasm32-unknown-emscripten" ] || [ "$HOST" = "wasm32-unknown-emscripten" ] || [ "$TGT" = "wasm32-unknown-emscripten" ]; then
    IS_WASM=1
fi

# 2. Check arguments for wasm32-unknown-emscripten
for arg in "$@"; do
    case "$arg" in
        *wasm32-unknown-emscripten*)
            IS_WASM=1
            ;;
    esac
done

# 3. Check if CC explicitly contains emcc (safer than checking PATH)
if [ "$IS_WASM" = "0" ]; then
    if echo "$CC" | grep -q "emcc"; then
        IS_WASM=1
    fi
fi

if [ "$IS_WASM" = "1" ]; then
    echo "Configuring for WebAssembly..."
    # For WASM/WebR, keep target dir local to avoid rwasm copy issues
    TARGET_DIR="./target"
    GC_SECTIONS="-Wl,--gc-sections"
    # For WASM, do NOT use --whole-archive or legacy -u flags
    # We add -s EXPORT_ALL=0 to prevent internal Rust symbols from causing errors
    # and explicitly list our required entry points.
    UNDEFINED_FLAGS="-s SIDE_MODULE=2 -L${TARGET_DIR}/release -lrfastlowess -s EXPORT_ALL=0 -s EXPORTED_FUNCTIONS=['_R_init_rfastlowess','_wrap__smooth','_wrap__smooth_streaming','_wrap__smooth_online']"
elif [ "$UNAME" = "Darwin" ]; then
    echo "Configuring for macOS..."
    # On macOS, use -force_load with explicit path to include only needed symbols
    GC_SECTIONS=""
    UNDEFINED_FLAGS="-Wl,-force_load,${TARGET_DIR}/release/librfastlowess.a"
else
    echo "Configuring for Linux/Unix..."
    # Default to Linux flags - use whole-archive to include all symbols
    GC_SECTIONS=""
    UNDEFINED_FLAGS="-Wl,--whole-archive,${TARGET_DIR}/release/librfastlowess.a -Wl,--no-whole-archive"
fi

# Check if template exists
if [ ! -f "src/Makevars.in" ]; then
    echo "ERROR: src/Makevars.in not found!"
    exit 1
fi

# Substitute variables in src/Makevars.in
sed -e "s|@GC_SECTIONS@|${GC_SECTIONS}|g" \
    -e "s|@UNDEFINED_FLAGS@|${UNDEFINED_FLAGS}|g" \
    -e "s|@TARGET_DIR@|${TARGET_DIR}|g" \
    src/Makevars.in > src/Makevars

# Ensure final newline
echo "" >> src/Makevars

echo "Generated src/Makevars"
echo "Target Directory: ${TARGET_DIR}"
echo "WASM detected: ${IS_WASM}"

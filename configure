#!/bin/sh

# Detect OS
# This script configures the package for cross-platform builds
UNAME=$(uname)

# Default to Linux flags
GC_SECTIONS="-Wl,--gc-sections"
UNDEFINED_FLAGS=""

if [ "$UNAME" = "Darwin" ]; then
    echo "Configuring for macOS..."
    # macOS uses -dead_strip instead of --gc-sections
    GC_SECTIONS="-Wl,-dead_strip"
else
    echo "Configuring for Linux/Unix..."
fi

# Check if template exists
if [ ! -f "src/Makevars.in" ]; then
    echo "ERROR: src/Makevars.in not found!"
    echo "PWD: $(pwd)"
    ls -F src/
    exit 1
fi

# Substitute variables in src/Makevars.in
sed -e "s|@GC_SECTIONS@|${GC_SECTIONS}|g" \
    -e "s|@UNDEFINED_FLAGS@|${UNDEFINED_FLAGS}|g" \
    src/Makevars.in > src/Makevars

# Ensure final newline
echo "" >> src/Makevars

echo "Generated src/Makevars"

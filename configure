#!/bin/sh

# Detect OS
# This script configures the package for cross-platform builds
UNAME=$(uname)

# Default to Linux flags
GC_SECTIONS="-Wl,--gc-sections"
# Symbols need -u flag. On Linux, symbols do usually NOT have a leading underscore.
# However, R's C entry points usually match the function name.
UNDEFINED_FLAGS="-Wl,-u,R_init_fastLowess -Wl,-u,wrap__smooth -Wl,-u,wrap__smooth_streaming -Wl,-u,wrap__smooth_online"

if [ "$UNAME" = "Darwin" ]; then
    echo "Configuring for macOS..."
    # macOS uses -dead_strip instead of --gc-sections
    GC_SECTIONS="-Wl,-dead_strip"
    # macOS symbols typically have a leading underscore in Mach-O
    UNDEFINED_FLAGS="-Wl,-u,_R_init_fastLowess -Wl,-u,_wrap__smooth -Wl,-u,_wrap__smooth_streaming -Wl,-u,_wrap__smooth_online"
else
    echo "Configuring for Linux/Unix..."
fi

# Check if template exists
if [ ! -f "src/Makevars.in" ]; then
    echo "ERROR: src/Makevars.in not found!"
    echo "PWD: $(pwd)"
    ls -F src/
    exit 1
fi

# Substitute variables in src/Makevars.in
sed -e "s|@GC_SECTIONS@|${GC_SECTIONS}|g" \
    -e "s|@UNDEFINED_FLAGS@|${UNDEFINED_FLAGS}|g" \
    src/Makevars.in > src/Makevars

# Ensure final newline
echo "" >> src/Makevars

echo "Generated src/Makevars"

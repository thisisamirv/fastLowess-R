#!/bin/sh

# Detect OS
# This script configures the package for cross-platform builds
UNAME=$(uname)

# Default target directory
TARGET_DIR="../target"

# Default to Linux flags - use whole-archive to include all symbols from our library
GC_SECTIONS=""
UNDEFINED_FLAGS="-Wl,--whole-archive,${TARGET_DIR}/release/libfastlowess.a -Wl,--no-whole-archive"

# Check for WASM build (R-universe sets CARGO_BUILD_TARGET)
if [ "$CARGO_BUILD_TARGET" = "wasm32-unknown-emscripten" ]; then
    echo "Configuring for WebAssembly..."
    TARGET_DIR="./target"
    GC_SECTIONS=""
    UNDEFINED_FLAGS="-L${TARGET_DIR}/release -lfastlowess"
elif [ "$UNAME" = "Darwin" ]; then
    echo "Configuring for macOS..."
    # On macOS, use -force_load with explicit path to include only needed symbols
    GC_SECTIONS=""
    UNDEFINED_FLAGS="-Wl,-force_load,${TARGET_DIR}/release/libfastlowess.a"
else
    echo "Configuring for Linux/Unix..."
fi

# Check if template exists
if [ ! -f "src/Makevars.in" ]; then
    echo "ERROR: src/Makevars.in not found!"
    echo "PWD: $(pwd)"
    ls -F src/
    exit 1
fi

# Substitute variables in src/Makevars.in
sed -e "s|@GC_SECTIONS@|${GC_SECTIONS}|g" \
    -e "s|@UNDEFINED_FLAGS@|${UNDEFINED_FLAGS}|g" \
    -e "s|@TARGET_DIR@|${TARGET_DIR}|g" \
    src/Makevars.in > src/Makevars

# Ensure final newline
echo "" >> src/Makevars

echo "Generated src/Makevars"

#!/bin/sh

# Detect OS
# This script configures the package for cross-platform builds
UNAME=$(uname)

# Default to Linux flags
GC_SECTIONS="-Wl,--gc-sections"
# On Linux, we need -u flags to prevent symbol stripping
UNDEFINED_FLAGS="-Wl,-u,R_init_fastlowess -Wl,-u,wrap__smooth -Wl,-u,wrap__smooth_streaming -Wl,-u,wrap__smooth_online"

if [ "$UNAME" = "Darwin" ]; then
    echo "Configuring for macOS..."
    # On macOS, don't use -dead_strip or -u flags
    # -dead_strip causes Rust symbols to be stripped
    # -u with underscore prefix doesn't match Rust's symbol exports
    GC_SECTIONS=""
    UNDEFINED_FLAGS=""
else
    echo "Configuring for Linux/Unix..."
fi

# Check if template exists
if [ ! -f "src/Makevars.in" ]; then
    echo "ERROR: src/Makevars.in not found!"
    echo "PWD: $(pwd)"
    ls -F src/
    exit 1
fi

# Substitute variables in src/Makevars.in
sed -e "s|@GC_SECTIONS@|${GC_SECTIONS}|g" \
    -e "s|@UNDEFINED_FLAGS@|${UNDEFINED_FLAGS}|g" \
    src/Makevars.in > src/Makevars

# Ensure final newline
echo "" >> src/Makevars

echo "Generated src/Makevars"
